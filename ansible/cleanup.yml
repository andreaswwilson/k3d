---
# Run with: sudo -v && ansible-playbook cleanup.yml --become
- name: Destroy k3d cluster and clean up
  hosts: localhost
  become: false
  tasks:
    - name: Load .env file
      ansible.builtin.shell: grep -E '^POSTGRES_PASSWORD=' {{ playbook_dir }}/../.env | cut -d= -f2-
      register: env_password
      changed_when: false
      failed_when: false

    - name: Set postgres password from .env
      ansible.builtin.set_fact:
        postgres_password: "{{ env_password.stdout | default('unused') }}"

    - name: Check if OpenTofu state exists
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../tofu/terraform.tfstate"
      register: tfstate

    - name: Destroy OpenTofu resources
      ansible.builtin.command: >
        tofu destroy -auto-approve
        -var="postgres_password={{ postgres_password }}"
        -var="tls_cert_path={{ playbook_dir }}/../certs/andreas.local.pem"
        -var="tls_key_path={{ playbook_dir }}/../certs/andreas.local-key.pem"
      args:
        chdir: "{{ playbook_dir }}/../tofu"
      failed_when: false
      when: tfstate.stat.exists

    - name: Delete k3d cluster andreas
      ansible.builtin.command: k3d cluster delete andreas
      register: cluster_delete
      changed_when: "'Deleted' in cluster_delete.stdout"
      failed_when: false

    - name: Remove andreas.local from /etc/hosts
      become: true
      ansible.builtin.lineinfile:
        path: /etc/hosts
        line: "127.0.0.1 andreas.local"
        state: absent

    - name: Remove certificates directory
      ansible.builtin.file:
        path: "{{ playbook_dir }}/../certs"
        state: absent

    - name: Remove .env file
      ansible.builtin.file:
        path: "{{ playbook_dir }}/../.env"
        state: absent

    - name: Remove OpenTofu state
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ playbook_dir }}/../tofu/.terraform"
        - "{{ playbook_dir }}/../tofu/.terraform.lock.hcl"
        - "{{ playbook_dir }}/../tofu/terraform.tfstate"
        - "{{ playbook_dir }}/../tofu/terraform.tfstate.backup"
