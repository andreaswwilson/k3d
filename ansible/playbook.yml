---
# Run with: sudo -v && ansible-playbook playbook.yml --become
- name: Setup k3d environment
  hosts: localhost
  become: false
  tasks:
    - name: Check required tools
      ansible.builtin.include_tasks: tasks/check_tools.yml

    - name: Create k3d cluster
      ansible.builtin.include_tasks: tasks/create_cluster.yml

    - name: Generate environment config
      ansible.builtin.include_tasks: tasks/generate_env.yml

    - name: Create certificates
      ansible.builtin.include_tasks: tasks/create_certs.yml

    - name: Build and import frontend image
      ansible.builtin.include_tasks: tasks/build_frontend.yml

    - name: Deploy with OpenTofu
      ansible.builtin.include_tasks: tasks/tofu_apply.yml

    - name: Add 127.0.0.1 andreas.local to /etc/hosts if missing
      become: true
      ansible.builtin.lineinfile:
        path: /etc/hosts
        line: "127.0.0.1 andreas.local"
        state: present
