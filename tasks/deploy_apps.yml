---
- name: Check if postgres-credentials secret exists
  ansible.builtin.command: kubectl get secret postgres-credentials -n andreas
  register: pg_secret_check
  changed_when: false
  failed_when: false

- name: Create postgres-credentials secret
  ansible.builtin.command: >
    kubectl create secret generic postgres-credentials
    --from-literal=password={{ postgres_password }}
    -n andreas
  when: pg_secret_check.rc != 0

- name: Deploy frontend
  ansible.builtin.command: kubectl apply -f {{ playbook_dir }}/manifests/frontend.yml
  register: frontend_deploy
  changed_when: "'created' in frontend_deploy.stdout or 'configured' in frontend_deploy.stdout"

- name: Deploy backend
  ansible.builtin.command: kubectl apply -f {{ playbook_dir }}/manifests/backend.yml
  register: backend_deploy
  changed_when: "'created' in backend_deploy.stdout or 'configured' in backend_deploy.stdout"

- name: Deploy postgres
  ansible.builtin.command: kubectl apply -f {{ playbook_dir }}/manifests/postgres.yml
  register: postgres_deploy
  changed_when: "'created' in postgres_deploy.stdout or 'configured' in postgres_deploy.stdout"

- name: Deploy ingress
  ansible.builtin.command: kubectl apply -f {{ playbook_dir }}/manifests/ingress.yml
  register: ingress_deploy
  changed_when: "'created' in ingress_deploy.stdout or 'configured' in ingress_deploy.stdout"

- name: Deploy network policy
  ansible.builtin.command: kubectl apply -f {{ playbook_dir }}/manifests/network-policy.yml
  register: netpol_deploy
  changed_when: "'created' in netpol_deploy.stdout or 'configured' in netpol_deploy.stdout"
